const u="gtrade:cart";function c(){try{const t=window.localStorage.getItem(u);if(!t)return{items:[]};const e=JSON.parse(t);return Array.isArray(e)?{items:e}:e&&Array.isArray(e.items)?e:{items:[]}}catch(t){return window.localStorage.removeItem(u),{items:[]}}}function w(t){try{const e=(t.items||[]).reduce((n,r)=>{var i;return n+Number((i=r.qty)!=null?i:0)},0);window.dispatchEvent(new Event("gtrade:cart:update")),window.dispatchEvent(new CustomEvent("cart:changed",{detail:{count:e,items:t.items}}))}catch(e){try{window.dispatchEvent(new Event("gtrade:cart:update")),window.dispatchEvent(new Event("cart:changed"))}catch(n){}}}function o(t){try{const e=y(t);window.localStorage.setItem(u,JSON.stringify(e)),w(e)}catch(e){console.error("cart write error（寫入錯誤）:",e)}}function y(t){return t?Array.isArray(t)?{items:t}:typeof t=="object"&&Array.isArray(t.items)?t:{items:[]}:{items:[]}}function g(){return c().items||[]}function h(){return g().reduce((t,e)=>{var n,r;return t+Number((r=(n=e.qty)!=null?n:e.quantity)!=null?r:0)},0)}function v(t,e=1){var m,f,l;if(!t||t.id==null)throw new Error("Invalid product（商品資料不完整）");const n=Number(e),r=Number.isFinite(n)&&n>0?n:1,a=c().items||[],s=a.findIndex(d=>String(d.id)===String(t.id));if(s>=0){const d=Number((f=(m=a[s].qty)!=null?m:a[s].quantity)!=null?f:0);a[s]={...a[s],...t,qty:d+r}}else a.push({id:t.id,title:(l=t.title)!=null?l:"",price:Number(t.price)||0,img:t.img||"",qty:r,storeName:t.storeName||t.sellerName||t.seller__name||"未知店家"});return o({items:a}),console.log("新增商品進購物車",t),a}function E(t,e){const r=c().items||[],i=r.findIndex(a=>String(a.id)===String(t));if(i>=0){const a=Math.max(0,Number(e)||0);a===0?r.splice(i,1):r[i].qty=a,o({items:r})}return r}function N(t){const n={items:(c().items||[]).filter(r=>String(r.id)!==String(t))};return o(n),n.items}function S(){return o({items:[]}),[]}export{v as a,h as b,S as c,g,N as r,E as u};
