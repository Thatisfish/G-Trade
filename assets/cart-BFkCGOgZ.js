const u="gtrade:cart";function s(){try{const t=window.localStorage.getItem(u);if(!t)return{items:[]};const r=JSON.parse(t);return Array.isArray(r)?{items:r}:r&&Array.isArray(r.items)?r:{items:[]}}catch(t){return window.localStorage.removeItem(u),{items:[]}}}function y(t){try{const r=(t.items||[]).reduce((n,e)=>{var a;return n+Number((a=e.qty)!=null?a:0)},0);window.dispatchEvent(new Event("gtrade:cart:update")),window.dispatchEvent(new CustomEvent("cart:changed",{detail:{count:r,items:t.items}}))}catch(r){try{window.dispatchEvent(new Event("gtrade:cart:update")),window.dispatchEvent(new Event("cart:changed"))}catch(n){}}}function o(t){try{const r=g(t);window.localStorage.setItem(u,JSON.stringify(r)),y(r)}catch(r){console.error("cart write error（寫入錯誤）:",r)}}function g(t){return t?Array.isArray(t)?{items:t}:typeof t=="object"&&Array.isArray(t.items)?t:{items:[]}:{items:[]}}function l(){return s().items||[]}function h(){return l().reduce((t,r)=>{var n,e;return t+Number((e=(n=r.qty)!=null?n:r.quantity)!=null?e:0)},0)}function v(t,r=1){var m,f,w;if(!t||t.id==null)throw new Error("Invalid product（商品資料不完整）");const n=Number(r),e=Number.isFinite(n)&&n>0?n:1,i=s().items||[],c=i.findIndex(d=>String(d.id)===String(t.id));if(c>=0){const d=Number((f=(m=i[c].qty)!=null?m:i[c].quantity)!=null?f:0);i[c]={...i[c],...t,qty:d+e}}else i.push({id:t.id,title:(w=t.title)!=null?w:"",price:Number(t.price)||0,img:t.img||"",qty:e});return o({items:i}),i}function E(t,r){const e=s().items||[],a=e.findIndex(i=>String(i.id)===String(t));if(a>=0){const i=Math.max(0,Number(r)||0);i===0?e.splice(a,1):e[a].qty=i,o({items:e})}return e}function S(t){const n={items:(s().items||[]).filter(e=>String(e.id)!==String(t))};return o(n),n.items}function b(){return o({items:[]}),[]}export{v as a,h as b,b as c,l as g,S as r,E as u};
